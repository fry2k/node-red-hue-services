<script type="text/javascript">
    RED.nodes.registerType('mh-hue-motion-sensor',{
        category: 'hue devices',
        defaults: {
            name:    {value:""},
            bridge:  {type:"mh-hue-api", required: true},
            uuid:    {value:"", required: true},
            state:   {value:true},
            multi:   {value:false},
            outputs: {value:1},
        },
        color: "#E6E0F8",
        inputs:0,
        outputs:1,
        icon: "font-awesome/fa-rss",
        label: function() {
            return this.name||"Hue Motion Sensor";
        },
        paletteLabel: "Hue Motion Sensor",
        oneditsave: function () {
            console.log("mh-hue-dimmer-switch.oneditsave()");
            var scope = this;
            scope.outputs = $("#node-input-multi").prop('checked') ? ($("#node-input-state").prop('checked') ? 4: 3) : 1;
        },
        oneditprepare: function() {
            console.log("mh-hue-motion-sensor.oneditprepare()");
            const scope = this;
            let options = [];

            function inputUUID() {
                console.log("mh-hue-motion-sensor.oneditprepare.inputUUID()");

                var current = $('#node-input-uuid').val();
                $('#input-select-uuid').empty();
                $('#input-select-uuid').append('<input type="text" id="node-input-uuid" placeholder="00000000-0000-0000-0000-000000000000" style="width: 100%" value="'+current+'" />');

                var button = $("#input-select-uuid-search");
                var icon = button.find("i");
                icon.removeClass("fa-pencil");
                icon.addClass("fa-search");
            }

            function findUUID() {
                console.log("mh-hue-motion-sensor.oneditprepare.findUUID()");

                // Add a notification on top of the page indicating that we are busy...
                var notification = RED.notify("Searching for Hue (Outdoor) Motion Sensor devices...", { type: "compact", modal: true, fixed: true });

                var current = $('#node-input-uuid').val();

                var bridgeConfig = RED.nodes.node($('#node-input-bridge option:selected').val());
                if(!bridgeConfig) { return false; }

                // retrieve the options list from the bridge config node
                // restrict the list to resources of type 'device' and with model_id 'Z3-1BRL'
                $.get("mh-hue/options", { 
                    bridge_id: bridgeConfig.id, 
                    type: "device", 
                    models: ["SML001","SML002"]
                })
                .done( function(data) {
                    var options = JSON.parse(data);

                    if(options.length <= 0)
                    {
                        notification.close();
                        RED.notify("No Hue (Outdoor) Motion Sensor devices found.", { type: "error" });
                        return false;
                    }

                    $("#node-input-uuid").typedInput({
                        types: [
                            {
                                value: current,
                                options: options
                            }
                        ]
                    });

                    var button = $("#input-select-uuid-search");
                    var icon = button.find("i");
                    icon.removeClass("fa-search");
                    icon.addClass("fa-pencil");

                    // Remove the notification
                    notification.close();
                })
                .fail(function()
                {
                    console.log("mh-hue-motion-sensor.oneditprepare.findUUID(): failed");

                    // Remove the notification
                    notification.close();
                    RED.notify("unknown error", "error");
                });
            }

            $('#input-select-uuid-search').click(function()
            {
                if($('#input-select-uuid').find(".red-ui-typedInput-container").length > 0) {
                    inputUUID();
                } else {
                    findUUID();
                }
            });
        }
    });
</script>

<script type="text/html" data-template-name="mh-hue-motion-sensor">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-bridge"><i class="fa fa-tag"></i> Bridge</label>
        <input type="text" id="node-input-bridge" style="width: calc(100% - 105px)">
    </div>
    <div class="form-row">
        <label for="node-input-uuid"><i class="fa fa-tag"></i> UUID</label>
        <div style="display: inline-flex; width: calc(100% - 105px)">
            <div id="input-select-uuid" style="flex-grow: 1;">
                <input type="text" id="node-input-uuid" style="width: 100%">
            </div>
            <button id="input-select-uuid-search" type="button" class="red-ui-button" style="margin-left: 10px;">
                <i class="fa fa-search"></i>
            </button>
        </div>
    </div>
    <div class="form-row">
        <div style="display: inline-flex; width: calc(100% - 105px)">
            <div id="input-select-state" style="flex-grow: 1;">
                <input type="checkbox" id="node-input-state" style="flex: 15px;">
            </div>
            <span style="width: 100%; margin-left: 10px;">
                Status events
            </span>
        </div>
    </div>
    <div class="form-row">
        <div style="display: inline-flex; width: calc(100% - 105px)">
            <div id="input-select-multi" style="flex-grow: 1;">
                <input type="checkbox" id="node-input-multi" style="flex: 15px;">
            </div>
            <span style="width: 100%; margin-left: 10px;">
                Seperate outputs
            </span>
        </div>
    </div>
</script>

<script type="text/html" data-help-name="mh-hue-motion-sensor">
    <p>A simple node that converts the message payloads into all lower-case characters</p>
</script>
