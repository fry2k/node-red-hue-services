<script type="text/javascript">
    RED.nodes.registerType('DimmerSwitchNode',{
        category: 'hue devices',
        defaults: {
            name:      { value:"" },
            bridge:    { type: "BridgeConfigNode", required: true },
            uuid:      { value:"", required: true },
            multi:     { value: false },
            translate: { value: false },
            buttons:   { value: [ 
                { 
                    "initial_press": "{ \"rtypes\":  [\"light\", \"grouped_light\" ], \"payload\": { \"on\": { \"on\": true } } }"
                },
                { 
                    "initial_press": "{ \"rtypes\":  [\"light\", \"grouped_light\" ], \"payload\": { \"dimming_delta\": { \"action\": \"up\", \"brightness_delta\": 25 } } }",
                    "repeat":  "{ \"rtypes\":  [\"light\", \"grouped_light\" ], \"payload\": { \"dimming_delta\": { \"action\": \"up\", \"brightness_delta\": 25 } } }"
                },
                { 
                    "initial_press": "{ \"rtypes\":  [\"light\", \"grouped_light\" ], \"payload\": { \"dimming_delta\": { \"action\": \"down\", \"brightness_delta\": 25 } } }",
                    "repeat":  "{ \"rtypes\":  [\"light\", \"grouped_light\" ], \"payload\": { \"dimming_delta\": { \"action\": \"down\", \"brightness_delta\": 25 } } }"
                },
                {
                    "initial_press": "{ \"rtypes\":  [\"light\", \"grouped_light\" ], \"payload\": { \"on\": { \"on\": false } } }"
                }
            ] },
            outputs:   { value: 1 },
        },
        color: "#C7E9C0",
        inputs:0,
        icon: "font-awesome/fa-circle-o",
        label: function() {
            return this.name||"Hue Dimmer Switch";
        },
        paletteLabel: "Hue Dimmer Switch",
        oneditsave: function () {
            console.log("DimmerSwitchNode.oneditsave()");
            var scope = this;
            var uuid = $('#node-input-uuid').val();
            var bridge = RED.nodes.node($('#node-input-bridge option:selected').val());
            var multi = $("#node-input-multi").prop('checked');
            if ((uuid) && (bridge))
            { 
                $.get("BridgeConfigNode/GetSortedDeviceServices", { 
                    bridge_id: bridge.id, 
                    uuid: uuid,
                })
                .done( function(data) {
                    var services = JSON.parse(data);
                    scope.outputs = services.length;
                    scope.outputLabels = [];
                    if (multi) {
                        services.forEach(service => {
                            scope.outputLabels.push(service.rtype);
                        });
                    } else {
                        scope.outputs = 1;
                        scope.outputLabels.push("output");
                    }
                });
            }

            for (var i = 0; i < 4; i++) {
                ["initial_press","repeat","short_release","long_release"].forEach((item) => {
                    this.buttons[i][item] = $("#node-input-button"+i+"-"+item).val();
                });
            }
            
        },
        oneditprepare: function() {
            console.log("DimmerSwitchNode.oneditprepare()");
            const scope = this;
            let options = [];

            function inputUUID() {
                console.log("DimmerSwitchNode.oneditprepare.inputUUID()");

                var current = $('#node-input-uuid').val();
                $('#input-select-uuid').empty();
                $('#input-select-uuid').append('<input type="text" id="node-input-uuid" placeholder="00000000-0000-0000-0000-000000000000" style="width: 100%" value="'+current+'" />');

                var button = $("#input-select-uuid-search");
                var icon = button.find("i");
                icon.removeClass("fa-pencil");
                icon.addClass("fa-search");
            }

            function findUUID() {
                console.log("DimmerSwitchNode.oneditprepare.findUUID()");

                // Add a notification on top of the page indicating that we are busy...
                var notification = RED.notify("Searching for Hue Dimmer Switch devices...", { type: "compact", modal: true, fixed: true });

                var current = $('#node-input-uuid').val();

                var bridge = RED.nodes.node($('#node-input-bridge option:selected').val());
                if(!bridge) { return false; }

                // retrieve the options list from the bridge config node
                // restrict the list to resources of type 'device' and with model_id 'Z3-1BRL'
                $.get("BridgeConfigNode/GetSortedResourceOptions", {
                    type: "device",
                    bridge_id: bridge.id,
                    models: ["RWL020","RWL021"]
                })
                .done( function(data) {
                    var options = JSON.parse(data);

                    if(options.length <= 0)
                    {
                        notification.close();
                        RED.notify("No Hue Dimmer Switch devices found.", { type: "error" });
                        return false;
                    }

                    $("#node-input-uuid").typedInput({
                        types: [
                            {
                                value: current,
                                options: options
                            }
                        ]
                    });

                    var button = $("#input-select-uuid-search");
                    var icon = button.find("i");
                    icon.removeClass("fa-search");
                    icon.addClass("fa-pencil");

                    // Remove the notification
                    notification.close();
                })
                .fail(function()
                {
                    console.log("DimmerSwitchNode.oneditprepare.findUUID(): failed");

                    // Remove the notification
                    notification.close();
                    RED.notify("unknown error", "error");
                });
            }

            var tabs = RED.tabs.create({
                id: "button-tabs",
                onchange: function(tab) {
                    $("#button-tabs-content").children().hide();
                    $("#" + tab.id).show();
                }
            });
            tabs.addTab({
                id: "button0-tab-body",
                label: "On"
            });
            tabs.addTab({
                id: "button1-tab-body",
                label: "Dim Up"
            });
            tabs.addTab({
                id: "button2-tab-body",
                label: "Dim Down"
            });
            tabs.addTab({
                id: "button3-tab-body",
                label: "Off"
            });

            tabs.activateTab("button0-tab-body");

            $('#input-select-uuid-search').click(function()
            {
                if($('#input-select-uuid').find(".red-ui-typedInput-container").length > 0) {
                    inputUUID();
                } else {
                    findUUID();
                }
            });

            $('#input-select-translate').change(function()
            {
                console.log("DimmerSwitchNode.oneditprepare.$('#input-select-translate').change()");
                var translate = $("#node-input-translate").prop('checked');

                if (translate==true) {
                    $("#button-tabs-header").show();
                    $("#button-tabs-content").show();
                } else {
                    $("#button-tabs-header").hide();
                    $("#button-tabs-content").hide();
                }

            });

            for (var i = 0; i < 4; i++) {
                ["initial_press","repeat","short_release","long_release"].forEach((item) => {
                    $("#node-input-button"+i+"-"+item).typedInput({
                        type:"json",
                        types:["json"]
                    });
                    $("#node-input-button"+i+"-"+item).typedInput("value",this.buttons[i][item]);
                });
            }

        }
    });
</script>

<script type="text/html" data-template-name="DimmerSwitchNode">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-bridge"><i class="fa fa-tag"></i> Bridge</label>
        <input type="text" id="node-input-bridge" style="width: calc(100% - 105px)">
    </div>
    <div class="form-row">
        <label for="node-input-uuid"><i class="fa fa-tag"></i> UUID</label>
        <div style="display: inline-flex; width: calc(100% - 105px)">
            <div id="input-select-uuid" style="flex-grow: 1;">
                <input type="text" id="node-input-uuid" style="width: 100%">
            </div>
            <button id="input-select-uuid-search" type="button" class="red-ui-button" style="margin-left: 10px;">
                <i class="fa fa-search"></i>
            </button>
        </div>
    </div>
    <div class="form-row">
        <div style="display: inline-flex; width: calc(100% - 105px)">
            <div id="input-select-multi" style="flex-grow: 1;">
                <input type="checkbox" id="node-input-multi" style="flex: 15px;">
            </div>
            <span style="width: 100%; margin-left: 10px;">
                Seperate outputs
            </span>
        </div>
    </div>
    <div class="form-row">
        <div style="display: inline-flex; width: calc(100% - 105px)">
            <div id="input-select-translate" style="flex-grow: 1;">
                <input type="checkbox" id="node-input-translate" style="flex: 15px;">
            </div>
            <span style="width: 100%; margin-left: 10px;">
                Translate button output
            </span>
        </div>
    </div>

    <div id="button-tabs-header" style="display: inline-flex; width: calc(100% - 105px)">
        <div class="form-row button-tabs-row">
            <ul style="min-width: 600px; margin-bottom: 20px;" id="button-tabs"></ul>
        </div>
    </div>
    <div id="button-tabs-content" style="min-height: calc(100% - 95px);">

        <div id="button0-tab-body" style="display:none">

            <div class="form-row">
                <label for="node-input-button0-initial_press"><i class="fa fa-tag"></i> Initial press</label>
                <input type="text" id="node-input-button0-initial_press" placeholder="">
            </div>
        
            <div class="form-row">
                <label for="node-input-button0-repeat"><i class="fa fa-tag"></i> Repeat</label>
                <input type="text" id="node-input-button0-repeat" placeholder="">
            </div>
        
            <div class="form-row">
                <label for="node-input-button0-short_release"><i class="fa fa-tag"></i> Short release</label>
                <input type="text" id="node-input-button0-short_release" placeholder="">
            </div>
        
            <div class="form-row">
                <label for="node-input-button0-long_release"><i class="fa fa-tag"></i> Long release</label>
                <input type="text" id="node-input-button0-long_release" placeholder="">
            </div>
        
        </div>

        <div id="button1-tab-body" style="display:none">

            <div class="form-row">
                <label for="node-input-button1-initial_press"><i class="fa fa-tag"></i> Initial press</label>
                <input type="text" id="node-input-button1-initial_press" placeholder="">
            </div>
        
            <div class="form-row">
                <label for="node-input-button1-repeat"><i class="fa fa-tag"></i> Repeat</label>
                <input type="text" id="node-input-button1-repeat" placeholder="">
            </div>
        
            <div class="form-row">
                <label for="node-input-button1-short_release"><i class="fa fa-tag"></i> Short release</label>
                <input type="text" id="node-input-button1-short_release" placeholder="">
            </div>
        
            <div class="form-row">
                <label for="node-input-button1-long_release"><i class="fa fa-tag"></i> Long release</label>
                <input type="text" id="node-input-button1-long_release" placeholder="">
            </div>
        
        </div>

        <div id="button2-tab-body" style="display:none">

            <div class="form-row">
                <label for="node-input-button2-initial_press"><i class="fa fa-tag"></i> Initial press</label>
                <input type="text" id="node-input-button2-initial_press" placeholder="">
            </div>
        
            <div class="form-row">
                <label for="node-input-button2-repeat"><i class="fa fa-tag"></i> Repeat</label>
                <input type="text" id="node-input-button2-repeat" placeholder="">
            </div>
        
            <div class="form-row">
                <label for="node-input-button2-short_release"><i class="fa fa-tag"></i> Short release</label>
                <input type="text" id="node-input-button2-short_release" placeholder="">
            </div>
        
            <div class="form-row">
                <label for="node-input-button2-long_release"><i class="fa fa-tag"></i> Long release</label>
                <input type="text" id="node-input-button2-long_release" placeholder="">
            </div>
        
        </div>

        <div id="button3-tab-body" style="display:none">

            <div class="form-row">
                <label for="node-input-button3-initial_press"><i class="fa fa-tag"></i> Initial press</label>
                <input type="text" id="node-input-button3-initial_press" placeholder="">
            </div>
        
            <div class="form-row">
                <label for="node-input-button3-repeat"><i class="fa fa-tag"></i> Repeat</label>
                <input type="text" id="node-input-button3-repeat" placeholder="">
            </div>
        
            <div class="form-row">
                <label for="node-input-button3-short_release"><i class="fa fa-tag"></i> Short release</label>
                <input type="text" id="node-input-button3-short_release" placeholder="">
            </div>
        
            <div class="form-row">
                <label for="node-input-button3-long_release"><i class="fa fa-tag"></i> Long release</label>
                <input type="text" id="node-input-button3-long_release" placeholder="">
            </div>
        
        </div>

    </div>

</script>

<script type="text/html" data-help-name="DimmerSwitchNode">
    <p>A simple node that converts the message payloads into all lower-case characters</p>
</script>
