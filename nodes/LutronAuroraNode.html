<script type="text/javascript">
    RED.nodes.registerType('LutronAuroraNode',{
        category: 'foh devices',
        defaults: {
            name:    {value:""},
            bridge:  {type:"BridgeConfigNode", required: true},
            uuid:    {value:"", required: true},
            multi:   {value:false},
            outputs: {value:1},
        },
        color: "#C7E9C0",
        inputs:0,
        icon: "font-awesome/fa-circle-o",
        label: function() {
            return this.name||"Lutron Aurora";
        },
        paletteLabel: "Lutron Aurora",
        oneditsave: function () {
            console.log("LutronAuroraNode.oneditsave()");
            var scope = this;
            var uuid = $('#node-input-uuid').val();
            var bridgeConfig = RED.nodes.node($('#node-input-bridge option:selected').val());
            var multi = $("#node-input-multi").prop('checked');
            if ((uuid) && (bridgeConfig))
            { 
                $.get("mh-hue/getSortedDeviceServices", { 
                    bridge_id: bridgeConfig.id, 
                    uuid: uuid,
                })
                .done( function(data) {
                    var services = JSON.parse(data);
                    scope.outputs = services.length;
                    scope.outputLabels = [];
                    if (multi) {
                        services.forEach(service => {
                            scope.outputLabels.push(service.rtype);
                        });
                    } else {
                        scope.outputs = 1;
                        scope.outputLabels.push("output");
                    }
                });
            }
        },
        oneditprepare: function() {
            console.log("LutronAuroraNode.oneditprepare()");
            const scope = this;
            let options = [];

            function inputUUID() {
                console.log("LutronAuroraNode.oneditprepare.inputUUID()");

                var current = $('#node-input-uuid').val();
                $('#input-select-uuid').empty();
                $('#input-select-uuid').append('<input type="text" id="node-input-uuid" placeholder="00000000-0000-0000-0000-000000000000" style="width: 100%" value="'+current+'" />');

                var button = $("#input-select-uuid-search");
                var icon = button.find("i");
                icon.removeClass("fa-pencil");
                icon.addClass("fa-search");
            }

            function findUUID() {
                console.log("LutronAuroraNode.oneditprepare.findUUID()");

                // Add a notification on top of the page indicating that we are busy...
                var notification = RED.notify("Searching for Lutron Aurora devices...", { type: "compact", modal: true, fixed: true });

                var current = $('#node-input-uuid').val();

                var bridgeConfig = RED.nodes.node($('#node-input-bridge option:selected').val());
                if(!bridgeConfig) { return false; }

                // retrieve the options list from the bridge config node
                // restrict the list to resources of type 'device' and with model_id 'Z3-1BRL'
                $.get("mh-hue/getSortedDeviceOptions", { 
                    bridge_id: bridgeConfig.id, 
                    models: ["Z3-1BRL"] 
                })
                .done( function(data) {
                    var options = JSON.parse(data);

                    if(options.length <= 0)
                    {
                        notification.close();
                        RED.notify("No Lutron Aurora devices found.", { type: "error" });
                        return false;
                    }

                    $("#node-input-uuid").typedInput({
                        types: [
                            {
                                value: current,
                                options: options
                            }
                        ]
                    });

                    var button = $("#input-select-uuid-search");
                    var icon = button.find("i");
                    icon.removeClass("fa-search");
                    icon.addClass("fa-pencil");

                    // Remove the notification
                    notification.close();
                })
                .fail(function()
                {
                    console.log("LutronAuroraNode.oneditprepare.findUUID(): failed");

                    // Remove the notification
                    notification.close();
                    RED.notify("unknown error", "error");
                });
            }

            $('#input-select-uuid-search').click(function()
            {
                if($('#input-select-uuid').find(".red-ui-typedInput-container").length > 0) {
                    inputUUID();
                } else {
                    findUUID();
                }
            });
        }
    });
</script>

<script type="text/html" data-template-name="LutronAuroraNode">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" style="width: calc(100% - 105px)">
    </div>
    <div class="form-row">
        <label for="node-input-bridge"><i class="fa fa-server"></i> Bridge</label>
        <input type="text" id="node-input-bridge" style="width: calc(100% - 105px)">
    </div>
    <div class="form-row">
        <label for="node-input-uuid"><i class="fa fa-tag"></i> UUID</label>
        <div style="display: inline-flex; width: calc(100% - 105px)">
            <div id="input-select-uuid" style="flex-grow: 1;">
                <input type="text" id="node-input-uuid" style="width: 100%">
            </div>
            <button id="input-select-uuid-search" type="button" class="red-ui-button" style="margin-left: 10px;">
                <i class="fa fa-search"></i>
            </button>
        </div>
    </div>
    <div class="form-row">
        <div style="display: inline-flex; width: calc(100% - 105px)">
            <div id="input-select-multi" style="flex-grow: 1;">
                <input type="checkbox" id="node-input-multi" style="flex: 15px;">
            </div>
            <span style="width: 100%; margin-left: 10px;">
                Seperate outputs
            </span>
        </div>
    </div>
</script>

<script type="text/html" data-help-name="LutronAuroraNode">
    <p>A simple node that converts the message payloads into all lower-case characters</p>
</script>
